import socket
import sys
from tabulate import tabulate
import re

target = input("Your target IPv4 address:\n")
ports_start = input("Start port:\n")
ports_end = input("End Port:\n")

service_patterns = {
    "SSH":["SSH","OpenSSH"],
    "HTTP": ["HTTP","Apache","nginx"],
    "FTP":["FTP","vsftpd","FileZilla"],
    "HIKVISION":["Hikvision"],
    "RTSP": ["RTSP", "rtsp"],
    "ONVIF": ["Onvif", "ONVIF"]
}
def detect_service(banner):
    for service, patterns in service_patterns.items():
        for pattern in patterns:
            if pattern in banner:
                return service
    return "UNKNOWN"
def port_scan(target,ports_start, ports_end):
    open_ports = []
    port_info = []
    for port in range(int(ports_start), int(ports_end) + 1):
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(0.5)
            result = sock.connect_ex((target,port))
            if result == 0:
                print(f"Port {port} is open!")
                open_ports.append(port)
                banner = sock.recv(1024).decode("utf-8").strip()
                try:
                    print(f"Banner for port {port}: {banner}")
                    service = detect_service(banner)
                    print(f"service for port {port}:{service}")
                    if service != "UNKNOWN":
                        version = get_service_version(service, banner)
                        print(f"Version for port {port} : {version}")
                        port_info.append([port, service, version])
                    else:
                        port_info.append([port, service, ""])
                except socket.error:
                    pass
                finally:
                    sock.close()
            elif result == 11:
                print(f"Port {port} is taking longer to respond...")
            else:
                print(f"Port {port} is close:(")
        except KeyboardInterrupt:
            print("Exiting...")
            sys.exit()
        except socket.gaierror:
            print("Host could not be resolved.")
            sys.exit()
        except socket.error:
            print(f"Couldn't connect to port {port}")
            continue
    headers = ["Port", "Service", "Version"]
    print(tabulate(port_info,headers=headers,tablefmt="grid"))

def extract_ssh_version(banner):
    version_pattern = r"SSH-2.0-(.*?)[ \n]"
    match = re.search(version_pattern, banner)

    if match:
        version = match.group(1)
        return version
    else:
        return "Unknown"  # Return "Unknown" if no version is found


def extract_http_version(banner):
    lines = banner.split("\n")
    print(lines)
    match = re.search("Server: (.+?)\s+Last-Modified: (.+)", banner)
    if match:
        version = match.group(1)
        return version
    else:
        return "Unknown"


def extract_ftp_version(banner):
    parts = banner.split()
    if len(parts) >= 2:
        version = parts
        return version
    else:
        return "Unknown"

def get_service_version(service, banner):
    if service == "SSH":
        return extract_ssh_version(banner)
    elif service == "HTTP":
        return extract_http_version(banner)
    elif service == "FTP":
        return extract_ftp_version(banner)
    return



start = port_scan(target, ports_start, ports_end)